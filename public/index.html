<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hockey Match Voting</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.10/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        -webkit-tap-highlight-color: transparent;
        font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }
      .card {
        box-shadow: 0 30px 80px rgba(15, 23, 42, 0.35);
        border-radius: 1.25rem;
        backdrop-filter: blur(18px);
        border: 1px solid rgba(148, 163, 184, 0.15);
      }
      .sticky-toggle {
        position: sticky;
        top: 0;
        z-index: 30;
        background: transparent;
      }
      .glow {
        position: absolute;
        filter: blur(120px);
        opacity: 0.4;
        z-index: -1;
      }
    </style>
  </head>
  <body class="min-h-screen bg-slate-950 text-slate-100">
    <div id="root"></div>
    <script type="text/babel">
      const { useEffect, useState } = React;
      const qs = new URLSearchParams(location.search);
      const tokenKey = "hockey_vote_token";
      
      function getToken() {
        let t = localStorage.getItem(tokenKey);
        if (!t) {
          t = crypto.randomUUID();
          localStorage.setItem(tokenKey, t);
        }
        return t;
      }
      const deviceToken = getToken();

      function Toggle({ view, setView }) {
        return (
          <div className="sticky-toggle px-4 pt-5">
            <div className="grid grid-cols-2 gap-2 p-1 bg-slate-900/60 rounded-3xl border border-slate-700/60">
              {["Vote", "Results"].map((v) => (
                <button
                  key={v}
                  onClick={() => setView(v)}
                  className={
                    (view === v
                      ? "bg-gradient-to-r from-emerald-400 via-cyan-400 to-blue-500 text-slate-900 shadow-lg"
                      : "bg-transparent text-slate-300 hover:text-white") +
                    " py-2.5 rounded-3xl font-semibold transition focus:outline-none"
                  }
                >
                  {v}
                </button>
              ))}
            </div>
          </div>
        );
      }

      function VoteForm({ game, onDone }) {
        const [voter, setVoter] = useState("");
        const [momVote, setMomVote] = useState("existing");
        const [momPlayer, setMomPlayer] = useState("");
        const [momNewPlayer, setMomNewPlayer] = useState("");
        const [momComment, setMomComment] = useState("");
        const [dodVote, setDodVote] = useState("existing");
        const [dodPlayer, setDodPlayer] = useState("");
        const [dodNewPlayer, setDodNewPlayer] = useState("");
        const [dodComment, setDodComment] = useState("");
        const [champagneMoment, setChampagneMoment] = useState("new");
        const [champagneExisting, setChampagneExisting] = useState("");
        const [champagneNew, setChampagneNew] = useState("");
        const [msg, setMsg] = useState("");
        const [results, setResults] = useState(null);

        // Load current results to show existing votes
        useEffect(() => {
          fetch(`/api/games/${game._id}/results`)
            .then((r) => r.json())
            .then(setResults)
            .catch(() => {});
        }, [game._id]);

        const availableForMom = game.teamSheet.filter(p => 
          p !== voter && (!results?.totals?.mom?.some(m => m.player === p) || false)
        );
        
        const availableForDod = game.teamSheet.filter(p => 
          p !== voter && (!results?.totals?.dod?.some(d => d.player === p) || false)
        );

        async function submit() {
          setMsg("");
          
          if (!voter) {
            setMsg("Please identify yourself from the dropdown");
            return;
          }

          const momPlayerName = momVote === "existing" ? momPlayer : momNewPlayer;
          const dodPlayerName = dodVote === "existing" ? dodPlayer : dodNewPlayer;
          const champagneText = champagneMoment === "new" ? champagneNew : 
            results?.champagneMoments?.find(cm => cm._id === champagneExisting)?.text || "";

          if (!momPlayerName || !dodPlayerName || !champagneText) {
            setMsg("Please complete all votes");
            return;
          }

          const payload = {
            voter: { name: voter, token: deviceToken },
            mom: { player: momPlayerName, comment: momComment },
            dod: { player: dodPlayerName, comment: dodComment },
            champagneMoment: champagneMoment === "new" 
              ? { textIfNew: champagneNew }
              : { eventId: champagneExisting }
          };

          const res = await fetch(`/api/games/${game._id}/votes`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          
          const json = await res.json();
          if (!res.ok) {
            setMsg(json.error || "Error submitting vote");
          } else {
            setMsg("✅ Vote saved!");
            setTimeout(() => onDone(), 1500);
          }
        }

        return (
          <div className="card bg-slate-900/80 p-6">
            <div className="mb-6 flex items-start justify-between gap-3">
              <div>
                <p className="text-sm uppercase tracking-[0.2em] text-emerald-300/80">Vote Now</p>
                <h2 className="text-2xl font-semibold leading-tight">
                  {game.teamName || "Hockey Team"}
                </h2>
                <p className="text-sm text-slate-300">
                  {game.date} · vs {game.opponents}
                </p>
              </div>
              <div className="rounded-full bg-emerald-400/20 px-3 py-1 text-xs font-semibold text-emerald-200">
                Secure ballot
              </div>
            </div>

            {/* Voter Identification */}
            <div className="mb-6">
              <label className="block text-sm font-medium text-slate-300 mb-2">
                Identify Yourself *
              </label>
              <select
                value={voter}
                onChange={(e) => setVoter(e.target.value)}
                className="w-full rounded-xl border border-slate-700/60 bg-slate-950/70 p-3 text-sm text-white focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
                required
              >
                <option value="">Select your name</option>
                {game.teamSheet.map((p) => (
                  <option key={p} value={p}>{p}</option>
                ))}
              </select>
            </div>

            {/* Man of the Match */}
            <div className="mb-6 rounded-2xl border border-slate-700/60 bg-slate-950/60 p-4">
              <h3 className="text-sm font-semibold uppercase tracking-[0.2em] text-emerald-300/80 mb-3">
                Man of the Match
              </h3>
              
              <div className="space-y-3">
                <label className="flex items-center gap-3">
                  <input
                    type="radio"
                    name="momType"
                    value="existing"
                    checked={momVote === "existing"}
                    onChange={(e) => setMomVote(e.target.value)}
                    className="accent-emerald-400"
                  />
                  <span className="text-slate-200">Vote for existing nominee</span>
                </label>
                
                {momVote === "existing" && (
                  <select
                    value={momPlayer}
                    onChange={(e) => setMomPlayer(e.target.value)}
                    className="w-full rounded-xl border border-slate-700/60 bg-slate-950/70 p-3 text-sm text-white focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
                  >
                    <option value="">Select player</option>
                    {results?.totals?.mom?.map((m) => (
                      <option key={m.player} value={m.player}>
                        {m.player} ({m.count} vote{m.count !== 1 ? 's' : ''})
                      </option>
                    ))}
                  </select>
                )}

                <label className="flex items-center gap-3">
                  <input
                    type="radio"
                    name="momType"
                    value="new"
                    checked={momVote === "new"}
                    onChange={(e) => setMomVote(e.target.value)}
                    className="accent-emerald-400"
                  />
                  <span className="text-slate-200">Nominate new player</span>
                </label>
                
                {momVote === "new" && (
                  <select
                    value={momNewPlayer}
                    onChange={(e) => setMomNewPlayer(e.target.value)}
                    className="w-full rounded-xl border border-emerald-400/40 bg-slate-950/70 p-3 text-sm text-white focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
                  >
                    <option value="">Select player to nominate</option>
                    {availableForMom.map((p) => (
                      <option key={p} value={p}>{p}</option>
                    ))}
                  </select>
                )}
                
                <input
                  placeholder="Comment (optional)"
                  value={momComment}
                  onChange={(e) => setMomComment(e.target.value)}
                  className="w-full rounded-xl border border-slate-700/60 bg-slate-950/70 p-3 text-sm text-white placeholder-slate-400 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
                />
              </div>
            </div>

            {/* Dick of the Day */}
            <div className="mb-6 rounded-2xl border border-slate-700/60 bg-slate-950/60 p-4">
              <h3 className="text-sm font-semibold uppercase tracking-[0.2em] text-rose-300/80 mb-3">
                Dick of the Day
              </h3>
              
              <div className="space-y-3">
                <label className="flex items-center gap-3">
                  <input
                    type="radio"
                    name="dodType"
                    value="existing"
                    checked={dodVote === "existing"}
                    onChange={(e) => setDodVote(e.target.value)}
                    className="accent-emerald-400"
                  />
                  <span className="text-slate-200">Vote for existing nominee</span>
                </label>
                
                {dodVote === "existing" && (
                  <select
                    value={dodPlayer}
                    onChange={(e) => setDodPlayer(e.target.value)}
                    className="w-full rounded-xl border border-slate-700/60 bg-slate-950/70 p-3 text-sm text-white focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
                  >
                    <option value="">Select player</option>
                    {results?.totals?.dod?.map((d) => (
                      <option key={d.player} value={d.player}>
                        {d.player} ({d.count} vote{d.count !== 1 ? 's' : ''})
                      </option>
                    ))}
                  </select>
                )}

                <label className="flex items-center gap-3">
                  <input
                    type="radio"
                    name="dodType"
                    value="new"
                    checked={dodVote === "new"}
                    onChange={(e) => setDodVote(e.target.value)}
                    className="accent-emerald-400"
                  />
                  <span className="text-slate-200">Nominate new player</span>
                </label>
                
                {dodVote === "new" && (
                  <select
                    value={dodNewPlayer}
                    onChange={(e) => setDodNewPlayer(e.target.value)}
                    className="w-full rounded-xl border border-emerald-400/40 bg-slate-950/70 p-3 text-sm text-white focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
                  >
                    <option value="">Select player to nominate</option>
                    {availableForDod.map((p) => (
                      <option key={p} value={p}>{p}</option>
                    ))}
                  </select>
                )}
                
                <input
                  placeholder="Comment (optional)"
                  value={dodComment}
                  onChange={(e) => setDodComment(e.target.value)}
                  className="w-full rounded-xl border border-slate-700/60 bg-slate-950/70 p-3 text-sm text-white placeholder-slate-400 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
                />
              </div>
            </div>

            {/* Champagne Moment */}
            <div className="mb-6 rounded-2xl border border-slate-700/60 bg-slate-950/60 p-4">
              <h3 className="text-sm font-semibold uppercase tracking-[0.2em] text-amber-300/80 mb-3">
                🥂 Champagne Moment
              </h3>
              
              {results?.champagneMoments?.length > 0 && (
                <div className="mb-3">
                  {results.champagneMoments.map((cm) => (
                    <label key={cm._id} className="mt-2 flex items-start gap-3 rounded-xl border border-transparent bg-slate-900/70 p-3 text-sm transition hover:border-emerald-400/40">
                      <input
                        type="radio"
                        name="champagne"
                        value={cm._id}
                        checked={champagneMoment === cm._id}
                        onChange={(e) => {
                          setChampagneMoment(e.target.value);
                          setChampagneExisting(e.target.value);
                        }}
                        className="mt-1 accent-emerald-400"
                      />
                      <div>
                        <span className="text-slate-200">{cm.text}</span>
                        <div className="text-xs text-slate-400 mt-1">
                          {cm.votes} vote{cm.votes !== 1 ? 's' : ''}
                        </div>
                      </div>
                    </label>
                  ))}
                </div>
              )}
              
              <label className="flex items-start gap-3 rounded-xl border border-dashed border-slate-700/60 bg-slate-900/40 p-3 text-sm transition hover:border-emerald-400/50">
                <input
                  type="radio"
                  name="champagne"
                  value="new"
                  checked={champagneMoment === "new"}
                  onChange={(e) => setChampagneMoment(e.target.value)}
                  className="mt-1 accent-emerald-400"
                />
                <span className="text-slate-200">Add new champagne moment</span>
              </label>
              
              {champagneMoment === "new" && (
                <textarea
                  placeholder="Describe the champagne moment (up to 100 characters)"
                  value={champagneNew}
                  onChange={(e) => setChampagneNew(e.target.value)}
                  maxLength={100}
                  className="mt-3 w-full rounded-xl border border-amber-400/40 bg-slate-950/70 p-3 text-sm text-white placeholder-slate-400 focus:border-amber-400 focus:outline-none focus:ring-2 focus:ring-amber-500/60"
                  rows={3}
                />
              )}
            </div>

            {msg && (
              <p className={`mb-4 text-sm font-medium ${
                msg.includes("✅") ? "text-emerald-300" : "text-rose-400"
              }`}>
                {msg}
              </p>
            )}
            
            <button
              onClick={submit}
              className="w-full rounded-xl bg-gradient-to-r from-emerald-400 via-cyan-400 to-blue-500 py-3 text-base font-semibold text-slate-900 shadow-lg shadow-emerald-500/20 transition hover:brightness-105"
            >
              Submit Vote
            </button>
          </div>
        );
      }

      function Results({ game }) {
        const [data, setData] = useState(null);
        
        useEffect(() => {
          fetch(`/api/games/${game._id}/results`)
            .then((r) => r.json())
            .then(setData)
            .catch(() => {});
        }, [game._id]);
        
        if (!data) {
          return (
            <div className="card bg-slate-900/80 p-6 text-sm text-slate-200">
              Loading results...
            </div>
          );
        }

        return (
          <div className="card bg-slate-900/80 p-6">
            <div className="mb-6 flex items-center justify-between">
              <div>
                <p className="text-sm uppercase tracking-[0.2em] text-emerald-300/80">
                  Live Results
                </p>
                <h2 className="text-2xl font-semibold">Standings</h2>
              </div>
              <span className="rounded-full bg-emerald-400/10 px-3 py-1 text-xs font-semibold text-emerald-200">
                {data.game.date}
              </span>
            </div>
            
            <div className="space-y-6">
              {/* Man of the Match Results */}
              <div>
                <h3 className="text-sm font-semibold uppercase tracking-[0.25em] text-emerald-300/80 mb-3">
                  Man of the Match
                </h3>
                <div className="space-y-2">
                  {data.totals?.mom?.length ? (
                    data.totals.mom.map((m, idx) => {
                      const highest = Math.max(1, ...data.totals.mom.map(t => t.count));
                      return (
                        <div key={m.player + idx} className="overflow-hidden rounded-xl border border-slate-700/60 bg-slate-950/60">
                          <div className="flex items-center justify-between px-3 py-2 text-sm">
                            <span className="font-medium text-slate-200">{m.player}</span>
                            <span className="text-xs text-slate-300">
                              {m.count} vote{m.count === 1 ? "" : "s"}
                            </span>
                          </div>
                          <div className="h-1.5 bg-slate-800">
                            <div
                              className="h-full bg-gradient-to-r from-emerald-400 to-green-500"
                              style={{ width: `${Math.max((m.count / highest) * 100, 8)}%` }}
                            ></div>
                          </div>
                        </div>
                      );
                    })
                  ) : (
                    <p className="text-xs text-slate-400">No votes yet.</p>
                  )}
                </div>
              </div>

              {/* Dick of the Day Results */}
              <div>
                <h3 className="text-sm font-semibold uppercase tracking-[0.25em] text-rose-300/80 mb-3">
                  Dick of the Day
                </h3>
                <div className="space-y-2">
                  {data.totals?.dod?.length ? (
                    data.totals.dod.map((d, idx) => {
                      const highest = Math.max(1, ...data.totals.dod.map(t => t.count));
                      return (
                        <div key={d.player + idx} className="overflow-hidden rounded-xl border border-slate-700/60 bg-slate-950/60">
                          <div className="flex items-center justify-between px-3 py-2 text-sm">
                            <span className="font-medium text-slate-200">{d.player}</span>
                            <span className="text-xs text-slate-300">
                              {d.count} vote{d.count === 1 ? "" : "s"}
                            </span>
                          </div>
                          <div className="h-1.5 bg-slate-800">
                            <div
                              className="h-full bg-gradient-to-r from-rose-400 to-red-500"
                              style={{ width: `${Math.max((d.count / highest) * 100, 8)}%` }}
                            ></div>
                          </div>
                        </div>
                      );
                    })
                  ) : (
                    <p className="text-xs text-slate-400">No votes yet.</p>
                  )}
                </div>
              </div>

              {/* Champagne Moments Results */}
              <div>
                <h3 className="text-sm font-semibold uppercase tracking-[0.25em] text-amber-300/80 mb-3">
                  🥂 Champagne Moments
                </h3>
                <div className="space-y-3">
                  {data.champagneMoments?.length ? (
                    data.champagneMoments.map((cm, idx) => {
                      const highest = Math.max(1, ...data.champagneMoments.map(c => c.votes));
                      return (
                        <div key={cm._id || idx} className="overflow-hidden rounded-xl border border-slate-700/60 bg-slate-950/60">
                          <div className="px-3 py-3">
                            <div className="flex items-start justify-between gap-3 mb-2">
                              <span className="text-sm text-slate-200 leading-relaxed">{cm.text}</span>
                              <span className="text-xs text-slate-300 whitespace-nowrap">
                                {cm.votes} vote{cm.votes === 1 ? "" : "s"}
                              </span>
                            </div>
                            <div className="h-1.5 bg-slate-800 rounded-full">
                              <div
                                className="h-full bg-gradient-to-r from-amber-400 to-yellow-500 rounded-full"
                                style={{ width: `${Math.max((cm.votes / highest) * 100, 8)}%` }}
                              ></div>
                            </div>
                          </div>
                        </div>
                      );
                    })
                  ) : (
                    <p className="text-xs text-slate-400">No champagne moments yet.</p>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      }

      function App() {
        const [view, setView] = useState("Vote");
        const [game, setGame] = useState(null);
        const [loading, setLoading] = useState(true);
        const id = qs.get("gameId");
        
        useEffect(() => {
          if (id) {
            fetch(`/api/games/${id}`)
              .then((r) => r.json())
              .then(setGame)
              .catch(() => {})
              .finally(() => setLoading(false));
          } else {
            setLoading(false);
          }
        }, [id]);

        if (loading) {
          return (
            <div className="flex min-h-screen items-center justify-center">
              <div className="text-slate-300">Loading match...</div>
            </div>
          );
        }

        if (!game) {
          return (
            <div className="flex min-h-screen items-center justify-center">
              <div className="text-center">
                <h1 className="text-2xl font-semibold text-slate-200 mb-2">Match Not Found</h1>
                <p className="text-slate-400">Please check your link and try again.</p>
              </div>
            </div>
          );
        }

        return (
          <div className="relative overflow-hidden">
            <div className="glow left-[-10%] top-[-10%] h-80 w-80 rounded-full bg-emerald-500"></div>
            <div className="glow right-[-15%] bottom-[-10%] h-96 w-96 rounded-full bg-blue-500"></div>
            <div className="mx-auto flex min-h-screen max-w-lg flex-col gap-5 px-4 pb-12 pt-10">
              <header className="text-center">
                <p className="text-xs uppercase tracking-[0.4em] text-emerald-200/70">
                  Guildford Hockey Club
                </p>
                <h1 className="mt-2 text-4xl font-semibold">
                  Matchday Player Voting
                </h1>
                <p className="mt-3 text-sm text-slate-300">
                  Vote for Man of the Match, Dick of the Day, and Champagne Moments
                </p>
              </header>
              <Toggle view={view} setView={setView} />
              <div className="space-y-5">
                {view === "Vote" ? (
                  <VoteForm game={game} onDone={() => setView("Results")} />
                ) : (
                  <Results game={game} />
                )}
              </div>
              <footer className="pt-4 text-center text-xs text-slate-500">
                Built for modern club culture · Secure · Mobile ready
              </footer>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>