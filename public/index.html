<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hockey Match Voting</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.10/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        -webkit-tap-highlight-color: transparent;
        font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }
      .card {
        box-shadow: 0 30px 80px rgba(15, 23, 42, 0.35);
        border-radius: 1.25rem;
        backdrop-filter: blur(18px);
        border: 1px solid rgba(148, 163, 184, 0.15);
      }
      .sticky-toggle {
        position: sticky;
        top: 0;
        z-index: 30;
        background: transparent;
      }
      .glow {
        position: absolute;
        filter: blur(120px);
        opacity: 0.4;
        z-index: -1;
      }
    </style>
  </head>
  <body class="min-h-screen bg-slate-950 text-slate-100">
    <div id="root"></div>
    <script type="text/babel">
      const { useEffect, useState } = React;
      const qs = new URLSearchParams(location.search);
      const tokenKey = "hockey_vote_token";
      function getToken() {
        let t = localStorage.getItem(tokenKey);
        if (!t) {
          t = crypto.randomUUID();
          localStorage.setItem(tokenKey, t);
        }
        return t;
      }
      const deviceToken = getToken();

      function Toggle({ view, setView }) {
        return (
          <div className="sticky-toggle px-4 pt-5">
            <div className="grid grid-cols-2 gap-2 p-1 bg-slate-900/60 rounded-3xl border border-slate-700/60">
              {["Vote", "Results"].map((v) => (
                <button
                  key={v}
                  onClick={() => setView(v)}
                  className={
                    (view === v
                      ? "bg-gradient-to-r from-emerald-400 via-cyan-400 to-blue-500 text-slate-900 shadow-lg"
                      : "bg-transparent text-slate-300 hover:text-white") +
                    " py-2.5 rounded-3xl font-semibold transition focus:outline-none"
                  }
                >
                  {v}
                </button>
              ))}
            </div>
          </div>
        );
      }

      function parseTeamCsv(content) {
        const lines = content
          .split(/\r?\n/)
          .map((line) => line.trim())
          .filter(Boolean);
        if (lines.length <= 1) return [];
        return lines
          .slice(1)
          .map((line) => {
            const cells = line
              .split(",")
              .map((cell) => cell.replace(/^"|"$/g, "").trim());
            const shirt = cells[1] || "";
            const first = cells[2] || "";
            const last = cells[3] || "";
            const name = [first, last].filter(Boolean).join(" ");
            if (!name) return "";
            if (shirt && shirt.toLowerCase() !== "n/a") {
              return `#${shirt} ${name}`.trim();
            }
            return name;
          })
          .filter(Boolean);
      }

      function Organizer({ onCreated }) {
        const [date, setDate] = useState(new Date().toISOString().slice(0, 10));
        const [opponents, setOpponents] = useState("");
        const [teamName, setTeamName] = useState("Weysiders");
        const [clubName, setClubName] = useState("Guildford Hockey Club");
        const [teamSheet, setTeamSheet] = useState("");
        const [standouts, setStandouts] = useState("");
        const [error, setError] = useState("");
        const [loading, setLoading] = useState(false);

         function handleImportFile(e) {
          const file = e.target.files?.[0];
          if (!file) return;
          setError("");
          const reader = new FileReader();
          reader.onload = (ev) => {
            try {
              const text = ev.target?.result || "";
              if (typeof text !== "string") throw new Error("Invalid file content");
              const players = parseTeamCsv(text);
              if (!players.length)
                throw new Error("No players found in uploaded file");
              setTeamSheet(players.join("\n"));
            } catch (err) {
              setError(err.message || "Failed to import file");
            }
          };
          reader.onerror = () => setError("Failed to read file");
          reader.readAsText(file);
        }

        async function createGame() {
          setError("");
          const sheet = teamSheet
            .split(/\n|,/)
            .map((s) => s.trim())
            .filter(Boolean);
          if (!date || !opponents || !sheet.length) {
            setError("Please fill date, opponents, and team sheet.");
            return;
          }
          const standoutEvents = standouts
            .split(/\n/)
            .map((s) => s.trim())
            .filter(Boolean);
          setLoading(true);
          const res = await fetch("/api/games", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              date,
              opponents,
              teamName,
              clubName,
              teamSheet: sheet,
              standoutEvents,
            }),
          });
          const json = await res.json();
          setLoading(false);
          if (!res.ok) {
            setError(json.error || "Failed to create game");
          } else {
            onCreated(json);
            const url = new URL(location.href);
            url.searchParams.set("gameId", json._id);
            history.replaceState({}, "", url);
          }
        }

        return (
          <div className="card bg-slate-900/80 p-6">
            <div className="flex items-center gap-2 mb-2">
              <span className="inline-flex h-10 w-10 items-center justify-center rounded-full bg-gradient-to-br from-emerald-400 via-cyan-400 to-blue-500 text-slate-900 font-semibold">
                üèë
              </span>
              <div>
                <h2 className="text-xl font-semibold">Create Game</h2>
                <p className="text-sm text-slate-300">
                  Share the match details and auto-generate a voting link.
                </p>
              </div>
            </div>
            <div className="grid gap-4">
              <input
                type="date"
                value={date}
                onChange={(e) => setDate(e.target.value)}
                className="w-full rounded-xl border border-slate-700/60 bg-slate-950/70 p-3 text-sm text-white placeholder-slate-400 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
              />
              <input
                placeholder="Opponents"
                value={opponents}
                onChange={(e) => setOpponents(e.target.value)}
                className="w-full rounded-xl border border-slate-700/60 bg-slate-950/70 p-3 text-sm text-white placeholder-slate-400 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
              />
              <textarea
                placeholder="Team sheet (comma or new line separated)"
                value={teamSheet}
                onChange={(e) => setTeamSheet(e.target.value)}
                className="min-h-[110px] w-full rounded-xl border border-slate-700/60 bg-slate-950/70 p-3 text-sm text-white placeholder-slate-400 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
              ></textarea>
              <label className="text-sm text-slate-600">
                Import from CSV: 
                <input
                  type="file"
                  accept=".csv,text/csv"
                  onChange={handleImportFile}
                  className="min-h-[90px] w-full rounded-xl border border-slate-700/60 bg-slate-950/70 p-3 text-sm text-white placeholder-slate-400 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
                />
              </label>
              <textarea
                placeholder="Optional: standout events"
                value={standouts}
                onChange={(e) => setStandouts(e.target.value)}
                className="border rounded-lg p-2 w-full h-20"
              ></textarea>
              {error && <p className="text-rose-400 text-sm font-medium">{error}</p>}
              <button
                onClick={createGame}
                disabled={loading}
                className="inline-flex items-center justify-center rounded-xl bg-gradient-to-r from-emerald-400 via-cyan-400 to-blue-500 px-4 py-3 font-semibold text-slate-900 shadow-lg shadow-emerald-500/20 transition hover:brightness-105 disabled:cursor-not-allowed disabled:opacity-60"
              >
                {loading ? "Creating..." : "Create Game"}
              </button>
            </div>
          </div>
        );
      }

      function VoteForm({ game, onDone }) {
        const [name, setName] = useState("");
        const [mom, setMom] = useState("");
        const [momC, setMomC] = useState("");
        const [dod, setDod] = useState("");
        const [dodC, setDodC] = useState("");
        const [standout, setStandout] = useState(
          game.standoutEvents[0]?._id || "new"
        );
        const [standoutText, setStandoutText] = useState("");
        const [msg, setMsg] = useState("");

        async function submit() {
          setMsg("");
          const payload = {
            voter: { name, token: deviceToken },
            mom: { player: mom, comment: momC },
            dod: { player: dod, comment: dodC },
            standout:
              standout === "new"
                ? { textIfNew: standoutText }
                : { eventId: standout },
          };
          const res = await fetch(`/api/games/${game._id}/votes`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const json = await res.json();
          if (!res.ok) setMsg(json.error || "Error");
          else {
            setMsg("‚úÖ Vote saved!");
            onDone();
          }
        }

        return (
          <div className="card bg-slate-900/80 p-6">
            <div className="mb-4 flex items-start justify-between gap-3">
              <div>
                <p className="text-sm uppercase tracking-[0.2em] text-emerald-300/80">Vote Now</p>
                <h2 className="text-2xl font-semibold leading-tight">
                  {game.teamName || "Hockey Team"}
                </h2>
                <p className="text-sm text-slate-300">
                  {game.date} ¬∑ vs {game.opponents}
                </p>
              </div>
              <div className="rounded-full bg-emerald-400/20 px-3 py-1 text-xs font-semibold text-emerald-200">
                Secure ballot
              </div>
            </div>
            <input
              placeholder="Your name (optional)"
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="mb-3 w-full rounded-xl border border-slate-700/60 bg-slate-950/70 p-3 text-sm text-white placeholder-slate-400 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            />
            <select
              value={mom}
              onChange={(e) => setMom(e.target.value)}
              className="mb-3 w-full rounded-xl border border-slate-700/60 bg-slate-950/70 p-3 text-sm text-white focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            >
              <option value="">Select MoM</option>
              {game.teamSheet.map((p) => (
                <option key={p}>{p}</option>
              ))}
            </select>
            <input
              placeholder="Comment (optional)"
              value={momC}
              onChange={(e) => setMomC(e.target.value)}
              className="mb-3 w-full rounded-xl border border-slate-700/60 bg-slate-950/70 p-3 text-sm text-white placeholder-slate-400 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            />
            <select
              value={dod}
              onChange={(e) => setDod(e.target.value)}
               className="mb-3 w-full rounded-xl border border-slate-700/60 bg-slate-950/70 p-3 text-sm text-white focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            >
              <option value="">Select DoD</option>
              {game.teamSheet.map((p) => (
                <option key={p}>{p}</option>
              ))}
            </select>
            <input
              placeholder="Comment (optional)"
              value={dodC}
              onChange={(e) => setDodC(e.target.value)}
              className="mb-4 w-full rounded-xl border border-slate-700/60 bg-slate-950/70 p-3 text-sm text-white placeholder-slate-400 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            />
            <div className="mb-4 rounded-2xl border border-slate-700/60 bg-slate-950/60 p-4">
              <p className="text-sm font-semibold uppercase tracking-[0.2em] text-emerald-300/80">
                Standout Event
              </p>
              {game.standoutEvents.map((ev) => (
                <label key={ev._id} className="mt-3 flex items-start gap-3 rounded-xl border border-transparent bg-slate-900/70 p-3 text-sm transition hover:border-emerald-400/40">
                  <input
                    type="radio"
                    name="st"
                    checked={standout === ev._id}
                    onChange={() => setStandout(ev._id)}
                    className="mt-1 accent-emerald-400"
                  />
                    <span className="text-slate-200">{ev.text}</span>
                </label>
              ))}
              <label className="mt-3 flex items-start gap-3 rounded-xl border border-dashed border-slate-700/60 bg-slate-900/40 p-3 text-sm transition hover:border-emerald-400/50">
                <input
                  type="radio"
                  name="st"
                  checked={standout === "new"}
                  onChange={() => setStandout("new")}
                />
                <span className="text-slate-200">Add new event</span>
              </label>
              {standout === "new" && (
                <input
                  placeholder="Describe standout moment"
                  value={standoutText}
                  onChange={(e) => setStandoutText(e.target.value)}
                  className="mt-3 w-full rounded-xl border border-emerald-400/40 bg-slate-950/70 p-3 text-sm text-white placeholder-slate-400 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
                />
              )}
            </div>
            {msg && (
              <p
                className={`mb-3 text-sm font-medium ${
                  msg.includes("‚úÖ") ? "text-emerald-300" : "text-rose-400"
                }`}
              >
                {msg}
              </p>
            )}
            <button
              onClick={submit}
               className="w-full rounded-xl bg-gradient-to-r from-emerald-400 via-cyan-400 to-blue-500 py-3 text-base font-semibold text-slate-900 shadow-lg shadow-emerald-500/20 transition hover:brightness-105"
            >
              Submit Vote
            </button>
          </div>
        );
      }

      function Results({ game }) {
        const [data, setData] = useState(null);
        useEffect(() => {
          fetch(`/api/games/${game._id}/results`)
            .then((r) => r.json())
            .then(setData);
        }, [game._id]);
        if (!data)
          return (
            <div className="card bg-slate-900/80 p-6 text-sm text-slate-200">
              Loading results...
            </div>
          );
        return (
         <div className="card bg-slate-900/80 p-6">
            <div className="mb-4 flex items-center justify-between">
              <div>
                <p className="text-sm uppercase tracking-[0.2em] text-emerald-300/80">
                  Live Results
                </p>
               <h2 className="text-2xl font-semibold">Standings</h2>
              </div>
              <span className="rounded-full bg-emerald-400/10 px-3 py-1 text-xs font-semibold text-emerald-200">
                {data.game.date}
              </span>
            </div>
             <div className="space-y-5">
              {["mom", "dod"].map((key) => {
                const label = key === "mom" ? "Man of the Match" : "Dick of the Day";
                const totals = data.totals[key];
                const highest = Math.max(1, ...totals.map((t) => t.count));
                return (
                  <div key={key}>
                    <h3 className="text-sm font-semibold uppercase tracking-[0.25em] text-slate-300">
                      {label}
                    </h3>
                    <div className="mt-3 space-y-2">
                      {totals.length ? (
                        totals.map((m, idx) => (
                          <div
                            key={m.player + idx}
                            className="overflow-hidden rounded-xl border border-slate-700/60 bg-slate-950/60"
                          >
                            <div className="flex items-center justify-between px-3 py-2 text-sm">
                              <span className="font-medium text-slate-200">{m.player}</span>
                              <span className="text-xs text-slate-300">
                                {m.count} vote{m.count === 1 ? "" : "s"}
                              </span>
                            </div>
                            <div className="h-1.5 bg-slate-800">
                              <div
                                className="h-full bg-gradient-to-r from-emerald-400 via-cyan-400 to-blue-500"
                                style={{ width: `${Math.max((m.count / highest) * 100, 8)}%` }}
                              ></div>
                            </div>
                          </div>
                        ))
                      ) : (
                        <p className="text-xs text-slate-400">No votes yet.</p>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        );
      }

      function App() {
        const [view, setView] = useState("Vote");
        const [game, setGame] = useState(null);
        const id = qs.get("gameId");
        useEffect(() => {
          if (id)
            fetch(`/api/games/${id}`)
              .then((r) => r.json())
              .then(setGame);
        }, [id]);
        return (
           <div className="relative overflow-hidden">
            <div className="glow left-[-10%] top-[-10%] h-80 w-80 rounded-full bg-emerald-500"></div>
            <div className="glow right-[-15%] bottom-[-10%] h-96 w-96 rounded-full bg-blue-500"></div>
            <div className="mx-auto flex min-h-screen max-w-lg flex-col gap-5 px-4 pb-12 pt-10">
              <header className="text-center">
                <p className="text-xs uppercase tracking-[0.4em] text-emerald-200/70">
                  Guildford Hockey Club
                </p>
                <h1 className="mt-2 text-4xl font-semibold">
                  Matchday Player Voting
                </h1>
                <p className="mt-3 text-sm text-slate-300">
                  Streamlined match administration, beautifully presented for
                  your squad, supporters, and club staff.
                </p>
              </header>
              <Toggle view={view} setView={setView} />
              <div className="space-y-5">
                {!id && !game && <Organizer onCreated={setGame} />}
                {game &&
                  (view === "Vote" ? (
                    <VoteForm game={game} onDone={() => setView("Results")} />
                  ) : (
                    <Results game={game} />
                  ))}
              </div>
              <footer className="pt-4 text-center text-xs text-slate-500">
                Built for modern club culture ¬∑ Secure ¬∑ Mobile ready
              </footer>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
