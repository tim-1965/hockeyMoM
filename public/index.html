<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hockey Match Voting</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.10/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        -webkit-tap-highlight-color: transparent;
      }
      .card {
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
        border-radius: 1rem;
      }
      .sticky-toggle {
        position: sticky;
        top: 0;
        z-index: 30;
        background: white;
      }
    </style>
  </head>
  <body class="bg-slate-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useState } = React;
      const qs = new URLSearchParams(location.search);
      const tokenKey = "hockey_vote_token";
      function getToken() {
        let t = localStorage.getItem(tokenKey);
        if (!t) {
          t = crypto.randomUUID();
          localStorage.setItem(tokenKey, t);
        }
        return t;
      }
      const deviceToken = getToken();

      function Toggle({ view, setView }) {
        return (
          <div className="sticky-toggle px-3 pt-3">
            <div className="grid grid-cols-2 gap-2 p-1 bg-slate-200 rounded-2xl">
              {["Vote", "Results"].map((v) => (
                <button
                  key={v}
                  onClick={() => setView(v)}
                  className={
                    (view === v
                      ? "bg-white"
                      : "bg-transparent text-slate-600") +
                    " py-2 rounded-2xl font-medium transition"
                  }
                >
                  {v}
                </button>
              ))}
            </div>
          </div>
        );
      }

      function parseTeamCsv(content) {
        const lines = content
          .split(/\r?\n/)
          .map((line) => line.trim())
          .filter(Boolean);
        if (lines.length <= 1) return [];
        return lines
          .slice(1)
          .map((line) => {
            const cells = line
              .split(",")
              .map((cell) => cell.replace(/^"|"$/g, "").trim());
            const shirt = cells[1] || "";
            const first = cells[2] || "";
            const last = cells[3] || "";
            const name = [first, last].filter(Boolean).join(" ");
            if (!name) return "";
            if (shirt && shirt.toLowerCase() !== "n/a") {
              return `#${shirt} ${name}`.trim();
            }
            return name;
          })
          .filter(Boolean);
      }

      function Organizer({ onCreated }) {
        const [date, setDate] = useState(new Date().toISOString().slice(0, 10));
        const [opponents, setOpponents] = useState("");
        const [teamName, setTeamName] = useState("Weysiders");
        const [clubName, setClubName] = useState("Guildford Hockey Club");
        const [teamSheet, setTeamSheet] = useState("");
        const [standouts, setStandouts] = useState("");
        const [error, setError] = useState("");
        const [loading, setLoading] = useState(false);

         function handleImportFile(e) {
          const file = e.target.files?.[0];
          if (!file) return;
          setError("");
          const reader = new FileReader();
          reader.onload = (ev) => {
            try {
              const text = ev.target?.result || "";
              if (typeof text !== "string") throw new Error("Invalid file content");
              const players = parseTeamCsv(text);
              if (!players.length)
                throw new Error("No players found in uploaded file");
              setTeamSheet(players.join("\n"));
            } catch (err) {
              setError(err.message || "Failed to import file");
            }
          };
          reader.onerror = () => setError("Failed to read file");
          reader.readAsText(file);
        }

        async function createGame() {
          setError("");
          const sheet = teamSheet
            .split(/\n|,/)
            .map((s) => s.trim())
            .filter(Boolean);
          if (!date || !opponents || !sheet.length) {
            setError("Please fill date, opponents, and team sheet.");
            return;
          }
          const standoutEvents = standouts
            .split(/\n/)
            .map((s) => s.trim())
            .filter(Boolean);
          setLoading(true);
          const res = await fetch("/api/games", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              date,
              opponents,
              teamName,
              clubName,
              teamSheet: sheet,
              standoutEvents,
            }),
          });
          const json = await res.json();
          setLoading(false);
          if (!res.ok) {
            setError(json.error || "Failed to create game");
          } else {
            onCreated(json);
            const url = new URL(location.href);
            url.searchParams.set("gameId", json._id);
            history.replaceState({}, "", url);
          }
        }

        return (
          <div className="card bg-white p-4">
            <h2 className="text-xl font-semibold mb-2">Create Game</h2>
            <div className="grid gap-3">
              <input
                type="date"
                value={date}
                onChange={(e) => setDate(e.target.value)}
                className="border rounded-lg p-2 w-full"
              />
              <input
                placeholder="Opponents"
                value={opponents}
                onChange={(e) => setOpponents(e.target.value)}
                className="border rounded-lg p-2 w-full"
              />
              <textarea
                placeholder="Team sheet (comma or new line separated)"
                value={teamSheet}
                onChange={(e) => setTeamSheet(e.target.value)}
                className="border rounded-lg p-2 w-full h-24"
              ></textarea>
              <label className="text-sm text-slate-600">
                Import from CSV: 
                <input
                  type="file"
                  accept=".csv,text/csv"
                  onChange={handleImportFile}
                  className="block mt-1 text-sm"
                />
              </label>
              <textarea
                placeholder="Optional: standout events"
                value={standouts}
                onChange={(e) => setStandouts(e.target.value)}
                className="border rounded-lg p-2 w-full h-20"
              ></textarea>
              {error && <p className="text-red-600 text-sm">{error}</p>}
              <button
                onClick={createGame}
                disabled={loading}
                className="bg-black text-white rounded-xl py-3 font-semibold"
              >
                {loading ? "Creating..." : "Create Game"}
              </button>
            </div>
          </div>
        );
      }

      function VoteForm({ game, onDone }) {
        const [name, setName] = useState("");
        const [mom, setMom] = useState("");
        const [momC, setMomC] = useState("");
        const [dod, setDod] = useState("");
        const [dodC, setDodC] = useState("");
        const [standout, setStandout] = useState(
          game.standoutEvents[0]?._id || "new"
        );
        const [standoutText, setStandoutText] = useState("");
        const [msg, setMsg] = useState("");

        async function submit() {
          setMsg("");
          const payload = {
            voter: { name, token: deviceToken },
            mom: { player: mom, comment: momC },
            dod: { player: dod, comment: dodC },
            standout:
              standout === "new"
                ? { textIfNew: standoutText }
                : { eventId: standout },
          };
          const res = await fetch(`/api/games/${game._id}/votes`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const json = await res.json();
          if (!res.ok) setMsg(json.error || "Error");
          else {
            setMsg("âœ… Vote saved!");
            onDone();
          }
        }

        return (
          <div className="card bg-white p-4">
            <h2 className="text-xl font-semibold mb-3">
              Vote ({game.date} vs {game.opponents})
            </h2>
            <input
              placeholder="Your name (optional)"
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="border rounded-lg p-2 w-full mb-2"
            />
            <select
              value={mom}
              onChange={(e) => setMom(e.target.value)}
              className="border rounded-lg p-2 w-full mb-2"
            >
              <option value="">Select MoM</option>
              {game.teamSheet.map((p) => (
                <option key={p}>{p}</option>
              ))}
            </select>
            <input
              placeholder="Comment (optional)"
              value={momC}
              onChange={(e) => setMomC(e.target.value)}
              className="border rounded-lg p-2 w-full mb-2"
            />
            <select
              value={dod}
              onChange={(e) => setDod(e.target.value)}
              className="border rounded-lg p-2 w-full mb-2"
            >
              <option value="">Select DoD</option>
              {game.teamSheet.map((p) => (
                <option key={p}>{p}</option>
              ))}
            </select>
            <input
              placeholder="Comment (optional)"
              value={dodC}
              onChange={(e) => setDodC(e.target.value)}
              className="border rounded-lg p-2 w-full mb-2"
            />
            <div className="mb-3">
              <p className="text-sm font-semibold mb-1">Standout Event</p>
              {game.standoutEvents.map((ev) => (
                <label key={ev._id} className="flex items-center gap-2 mb-1">
                  <input
                    type="radio"
                    name="st"
                    checked={standout === ev._id}
                    onChange={() => setStandout(ev._id)}
                  />
                  <span>{ev.text}</span>
                </label>
              ))}
              <label className="flex items-center gap-2">
                <input
                  type="radio"
                  name="st"
                  checked={standout === "new"}
                  onChange={() => setStandout("new")}
                />
                <span>Add new event</span>
              </label>
              {standout === "new" && (
                <input
                  placeholder="Describe standout moment"
                  value={standoutText}
                  onChange={(e) => setStandoutText(e.target.value)}
                  className="border rounded-lg p-2 w-full mt-1"
                />
              )}
            </div>
            {msg && <p className="text-sm text-red-600 mb-2">{msg}</p>}
            <button
              onClick={submit}
              className="bg-black text-white rounded-xl py-3 font-semibold w-full"
            >
              Submit Vote
            </button>
          </div>
        );
      }

      function Results({ game }) {
        const [data, setData] = useState(null);
        useEffect(() => {
          fetch(`/api/games/${game._id}/results`)
            .then((r) => r.json())
            .then(setData);
        }, [game._id]);
        if (!data) return <p>Loading...</p>;
        return (
          <div className="card bg-white p-4">
            <h2 className="text-xl font-semibold mb-3">Results</h2>
            <div className="mb-2">
              <h3 className="font-semibold">Man of the Match</h3>
              {data.totals.mom.map((m) => (
                <p key={m.player}>
                  {m.player}: {m.count}
                </p>
              ))}
            </div>
            <div className="mb-2">
              <h3 className="font-semibold">Dick of the Day</h3>
              {data.totals.dod.map((m) => (
                <p key={m.player}>
                  {m.player}: {m.count}
                </p>
              ))}
            </div>
          </div>
        );
      }

      function App() {
        const [view, setView] = useState("Vote");
        const [game, setGame] = useState(null);
        const id = qs.get("gameId");
        useEffect(() => {
          if (id)
            fetch(`/api/games/${id}`)
              .then((r) => r.json())
              .then(setGame);
        }, [id]);
        return (
          <div className="max-w-md mx-auto p-3 space-y-3">
            <h1 className="text-2xl font-bold text-center">
              Hockey Match Voting
            </h1>
            <Toggle view={view} setView={setView} />
            {!id && !game && <Organizer onCreated={setGame} />}
            {game &&
              (view === "Vote" ? (
                <VoteForm game={game} onDone={() => setView("Results")} />
              ) : (
                <Results game={game} />
              ))}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
